#include <lib.h>
#include <daemons.h>

inherit LIB_DAEMON;

static void eventUpdate(){
    string config_file = read_file("/secure/include/config.h");
    string newfile = "#include <lib.h>\n";
    newfile += "\n";
    newfile += "inherit LIB_DAEMON;\n";
    newfile += "\n";
    newfile += "static void eventUpdate(){}\n";
    newfile += "\n";
    newfile += "static void create(){\n";
    newfile += "    daemon::create();\n";
    newfile += "    call_out((: eventUpdate :), 60);\n";
    newfile += "}\n";

    tc("Performing update tasks...");

    if(sizeof(config_file)){

	if(!grepp(config_file, "RESET_ALL"))
	    config_file = append_line(config_file,"#define TIME_TO_RESET",
	      "#define RESET_ALL                0");

        if(!grepp(config_file, "WEB_SOURCE"))
            config_file = append_line(config_file,"NM_STYLE_EXITS",
              "#define WEB_SOURCE               \"149.152.218.102\"");

	write_file("/secure/include/config.h", config_file+"\n", 1);
    }

    reload(EVENTS_D);
    EVENTS_D->AddEvent("/secure/daemon/file","/secure/daemon/file","ReadDir",({ }),90000,1);
    if(file_exists("/secure/scripts/qcs_check.scr"))
    rename("/secure/scripts/qcs_check.scr", "/secure/scripts/qcs_check.txt");
    mkdir("/domains/default/virtual");
    mkdir("/domains/default/virtual/sky");
    mkdir("/domains/default/virtual/arena");
    mkdir("/secure/upgrades/reverts");

    tc("Doing race stuff...");
   
    load_object("/secure/cmds/admins/removeraces")->cmd();
    load_object("/secure/cmds/admins/addraces")->cmd();

    tc("Almost done...");
    write_file("/secure/daemon/update.c",newfile,1);
    tc("Update tasks complete.");
}

static void create() {
    daemon::create();
    call_out((: eventUpdate :), 60);
}
